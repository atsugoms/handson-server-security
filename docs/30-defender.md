# ExXX: Defender for Cloud ã®æ´»ç”¨

#### â³ æ¨å®šæ™‚é–“: 15åˆ†

#### ğŸ’¡ å­¦ç¿’æ¦‚è¦

Defender for Cloud ã«å«ã¾ã‚Œã‚‹æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã€æ´»ç”¨ã—ã¦ã„ãæ–¹æ³•ã‚’å­¦ç¿’ã—ã¾ã™ã€‚

#### ğŸ—’ï¸ ç›®æ¬¡

1. [Defender CSPM ã®æœ‰åŠ¹åŒ–](#defender-cspm-ã®æœ‰åŠ¹åŒ–)
1. [Defender for Server ã®å€‹åˆ¥é©ç”¨](#defender-for-server-ã®å€‹åˆ¥é©ç”¨)


## Defender CSPM ã®æœ‰åŠ¹åŒ–

Defender for Cloud ã¯åŸºæœ¬çš„ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å˜ä½ã§æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
ä¸€éƒ¨ã®æ©Ÿèƒ½ã§ã¯ãƒªã‚½ãƒ¼ã‚¹å˜ä½ã§ã®æœ‰åŠ¹/ç„¡åŠ¹ã®åˆ‡ã‚Šæ›¿ãˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€æ©Ÿèƒ½ã«ã‚ˆã£ã¦å€‹åˆ¥é©ç”¨ã®æ–¹æ³•ãŒç•°ãªã‚Šã¾ã™ã€‚
ã¾ãšã¯ Defender CSPM ã‚’ä¾‹ã«åŸºæœ¬ã¨ãªã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å˜ä½ã§ã®æœ‰åŠ¹åŒ–ã«ã¤ã„ã¦å­¦ç¿’ã—ã¾ã™ã€‚

1. [Azure ãƒãƒ¼ã‚¿ãƒ«](https://portal.azure.com/) ã‚’é–‹ã

1. ä¸Šéƒ¨ã®æ¤œç´¢çª“ã‚’ä½¿ã£ã¦ Defender for Cloud ã‚’æ¢ã—ã¦é–‹ã

    ![](../images/ex03/001-cspm.png)

1. [ç®¡ç†]-[ç’°å¢ƒè¨­å®š] ã‚’é–‹ã

    ![](../images/ex03/002-cspm.png)

1. ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å±•é–‹ã—ã€ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ

    ![](../images/ex03/003-cspm.png)

1. Defender CSPM ã‚’ã€Œã‚ªãƒ³ã€ã«ã—ã¦ã€Œä¿å­˜ã€

    ![](../images/ex03/004-cspm.png)



## Defender for Server ã®å€‹åˆ¥é©ç”¨

Defender for Server ã¯å€‹åˆ¥é©ç”¨ãŒã§ãã‚‹ Defender ã«ãªã‚Šã¾ã™ã€‚
Defender for Server ã®å€‹åˆ¥é©ç”¨ã¯ã€Œå…¨ä½“é©ç”¨ã—ã¦ä¸€éƒ¨ã‚’é™¤å¤–ã€ã‹ã€Œå…¨ä½“ã¨ã—ã¦ã¯é©ç”¨ã›ãšä¸€éƒ¨ã ã‘ã«é©ç”¨ã€ã®ã©ã¡ã‚‰ã‹ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚
æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ Defender for Server ã‚’å€‹åˆ¥ã«é©ç”¨ã™ã‚‹æ‰‹é †ã«ã¤ã„ã¦å­¦ç¿’ã—ã¾ã™ã€‚

### Cloud Shellã€€ã®èµ·å‹•

1. [Azure ãƒãƒ¼ã‚¿ãƒ«](https://portal.azure.com/) ã‚’é–‹ã

1. Cloud Shell ã‚’èµ·å‹•

    ![](../images/ex03/101-servers.png)

1. å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã‚’æ“ä½œ

    - `Bash` ã¸åˆ‡ã‚Šæ›¿ãˆ
    - ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ

        ```
        az account set --subscription <YOUR_SUBSCRIPTION_ID>
        ```

### å€‹åˆ¥é©ç”¨æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–

1. ç’°å¢ƒå¤‰æ•°ã‚’æº–å‚™

    ```
    SUBSCRIPTION=<YOUR_SUBSCRIPTION_ID>
    SCOPE_SUBSC=subscriptions/$SUBSCRIPTION
    ```

1. ç¾çŠ¶ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã‚’ç¢ºèª

    ```
    az rest --url https://management.azure.com/$SCOPE_SUBSC/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 
    ```

    `properties.pricingTier` ã‚„ `properties.subPlan` ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ç„¡åŠ¹ã®å ´åˆã¯ `"pricingTier": "Free"` ã€æœ‰åŠ¹ã®å ´åˆã¯ `"pricingTier": "Standard"` ã®è¨­å®šãŒè¿”ã£ã¦ãã¾ã™ã€‚

    - <details>
        <summary>Defender for Servers ãŒç„¡åŠ¹ã®å¿œç­”ä¾‹: </summary>

        ```
        {
            "id": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/providers/Microsoft.Security/pricings/VirtualMachines",
            "name": "VirtualMachines",
            "properties": {
                "freeTrialRemainingTime": "PT0S",
                "pricingTier": "Free",
                "resourcesCoverageStatus": "NotCovered"
            },
            "type": "Microsoft.Security/pricings"
        }
        ```

        </details>

    - <details>
        <summary>Defender for Servers ãŒæœ‰åŠ¹ã®å¿œç­”ä¾‹:</summary>

        ```
        {
            "id": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/providers/Microsoft.Security/pricings/VirtualMachines",
            "name": "VirtualMachines",
            "properties": {
                "enablementTime": "2025-01-04T00:05:39.7654082Z",
                ... (çœç•¥) ...
                "freeTrialRemainingTime": "PT0S",
                "pricingTier": "Standard",
                "resourcesCoverageStatus": "FullyCovered",
                "subPlan": "P2"
            },
            "type": "Microsoft.Security/pricings"
        }
        ```

        </details>

1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€å€‹åˆ¥é©ç”¨ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ï¼ˆ `enforce: False`  ã‚’æŒ‡å®šã§å€‹åˆ¥é©ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ– ï¼‰

    ```
    az rest --method put \
        --url https://management.azure.com/$SCOPE_SUBSC/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 \
        --body "{'properties':{'pricingTier':'Free','enforce':'False'}}" \
        --verbose
    ```

    å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãŠã„ã¦ `properties.enforce: False` ã‚’ç¢ºèª

### å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã« Defender for Servers ã‚’é©ç”¨

1. ç’°å¢ƒå¤‰æ•°ã‚’æº–å‚™

    ```
    SUBSCRIPTION=<YOUR_SUBSCRIPTION_ID>
    RESOURCE_GROUP=<YOUR_RESOURCEGROUP_NAME>
    RESOURCE_PROVIDER=Microsoft.Compute 
    RESOURCE_TYPE=virtualMachines 
    RESOURCE_NAME=<YOUR_VM_NAME>
    SCOPE_RSCNM=subscriptions/$SUBSCRIPTION/resourceGroups/$RESOURCE_GROUP/providers/$RESOURCE_PROVIDER/$RESOURCE_TYPE/$RESOURCE_NAME
    ```

1. ç¾çŠ¶ã®ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã‚’ç¢ºèª

    ```
    az rest --url https://management.azure.com/$SCOPE_RSCNM/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 
    ```

    `properties.pricingTier` ã‚„ `properties.subPlan` ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ç„¡åŠ¹ã®å ´åˆã¯ `"pricingTier": "Free"` ã€æœ‰åŠ¹ã®å ´åˆã¯ `"pricingTier": "Standard"` ã®è¨­å®šãŒè¿”ã£ã¦ãã¾ã™ã€‚

1. å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ Defender for Server P1 ã‚’é©ç”¨

    ```
    az rest --method put \
        --url https://management.azure.com/$SCOPE_RSCNM/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 \
        --body "{'properties':{'pricingTier':'Standard','subPlan':'P1'}}" \
        --verbose 
    ```