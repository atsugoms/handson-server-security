# Ex01: Defender for Cloud ã®é©ç”¨

#### â³ æ¨å®šæ™‚é–“

- 10 ~ 15åˆ†

#### ğŸ’¡ å­¦ç¿’æ¦‚è¦

Defender for Cloud ã«å«ã¾ã‚Œã‚‹æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã€æ´»ç”¨ã—ã¦ã„ãæ–¹æ³•ã‚’å­¦ç¿’ã—ã¾ã™ã€‚

#### ğŸ—’ï¸ ç›®æ¬¡

Defender CSPM
1. [Defender CSPM ã®æœ‰åŠ¹åŒ–](#defender-cspm-ã®æœ‰åŠ¹åŒ–)

Defender for Servers
1. [Defender for Servers ã®æœ‰åŠ¹åŒ–](#defender-for-servers-ã®æœ‰åŠ¹åŒ–)
1. [Defender for Endpoint ã®å±•é–‹](#defender-for-endpoint-ã®å±•é–‹)
1. [è„†å¼±æ€§è©•ä¾¡ã®å±•é–‹](#è„†å¼±æ€§è©•ä¾¡ã®å±•é–‹)

å‚è€ƒ
* [Defender for Servers ã®å€‹åˆ¥é©ç”¨](#å‚è€ƒ-defender-for-servers-ã®å€‹åˆ¥é©ç”¨)

## Defender CSPM ã®æœ‰åŠ¹åŒ–

Defender for Cloud ã¯åŸºæœ¬çš„ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å˜ä½ã§æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
ä¸€éƒ¨ã®æ©Ÿèƒ½ã§ã¯ãƒªã‚½ãƒ¼ã‚¹å˜ä½ã§ã®æœ‰åŠ¹/ç„¡åŠ¹ã®åˆ‡ã‚Šæ›¿ãˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€æ©Ÿèƒ½ã«ã‚ˆã£ã¦å€‹åˆ¥é©ç”¨ã®æ–¹æ³•ãŒç•°ãªã‚Šã¾ã™ã€‚
ã¾ãšã¯ Defender CSPM ã‚’ä¾‹ã«åŸºæœ¬ã¨ãªã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å˜ä½ã§ã®æœ‰åŠ¹åŒ–ã«ã¤ã„ã¦å­¦ç¿’ã—ã¾ã™ã€‚

1. [Azure ãƒãƒ¼ã‚¿ãƒ«](https://portal.azure.com/) ã‚’é–‹ã

1. ä¸Šéƒ¨ã®æ¤œç´¢çª“ã‚’ä½¿ã£ã¦ Defender for Cloud ã‚’æ¢ã—ã¦é–‹ã

    ![](../images/ex01/001-cspm.png)

1. [ç®¡ç†]-[ç’°å¢ƒè¨­å®š] ã‚’é–‹ã

    ![](../images/ex01/002-cspm.png)

1. ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å±•é–‹ã—ã€ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ

    ![](../images/ex01/003-cspm.png)

1. Defender CSPM ã‚’ã€Œã‚ªãƒ³ã€ã«ã—ã¦ã€Œä¿å­˜ã€

    ![](../images/ex01/004-cspm.png)


## Defender for Servers ã®æœ‰åŠ¹åŒ–

ç¶šã„ã¦ Defender for Servers ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
Defender for Servers ã«ã¯è¤‡æ•°ã®æ©Ÿèƒ½ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€åŒ…å«ã•ã‚Œã‚‹æ©Ÿèƒ½ã«ã¤ã„ã¦ã‚‚æœ‰åŠ¹åŒ–ã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

1. Defender CSPM ã¨åŒã˜ç”»é¢ã«ã¦ã€ CWP ã® Defender for Servers ã‚’ã€Œã‚ªãƒ³ã€ã«å¤‰æ›´

    ![](../images/ex01/201-servers.png)

1. ãƒ—ãƒ©ãƒ³ã‚’ P2 ã«å¤‰æ›´

    ![](../images/ex01/202-servers.png)

1. è©³ç´°è¨­å®šã‚’é–‹ã

    ![](../images/ex01/203-servers.png)

1. ä»¥ä¸‹ã®ï¼’æ©Ÿèƒ½ã‚’ã€Œã‚ªãƒ³ã€ã«ã—ã¦ã€Œç¶šè¡Œã€

    - ãƒã‚·ãƒ³ã®è„†å¼±æ€§è©•ä¾¡
    - Endpoint Protection

    ![](../images/ex01/204-servers.png)

1. ã€Œä¿å­˜ã€

    ![](../images/ex01/205-servers.png)


## Defender for Endpoint ã®å±•é–‹

> [!IMPORTANT]
> æœ¬æ‰‹é †ã¯ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯å ´æ‰€ã®ç¢ºèªã ã‘è¡Œã„ã€å®Ÿéš›ã®ç¢ºèªã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™

Defender for Endpoint ã¯è‡ªå‹•å±•é–‹ã¨ãªã‚‹ãŸã‚ã€ç‰¹ã«æ“ä½œã¯è¡Œã„ã¾ã›ã‚“ã€‚
æœ€å¤§12æ™‚é–“ä»¥ä¸ŠçµŒéå¾Œã€ä»®æƒ³ãƒã‚·ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ä»¥ä¸‹ã®æ‰‹é †ã§ç¢ºèªã—ã¾ã™ã€‚

### Defender for Endpoint ã®é©ç”¨ï¼ˆè‡ªå‹•ï¼‰

* å‰è¿°ã®é€šã‚Šè‡ªå‹•é©ç”¨ã¨ãªã‚‹ãŸã‚ç‰¹ã«æ“ä½œã¯ä¸è¦

### Defender for Endpoint ã®é©ç”¨ç¢ºèª

1. Azureãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ãã€ä»®æƒ³ãƒã‚·ãƒ³ã‚’é–‹ã

1. [è¨­å®š]-[æ‹¡å¼µæ©Ÿèƒ½ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³] ã‚’é–‹ã

    ![](../images/ex01/301-endpoint.png)

1. `MDE.Windows` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

    ![](../images/ex01/302-endpoint.png)


## è„†å¼±æ€§è©•ä¾¡ã®å±•é–‹

è„†å¼±æ€§è©•ä¾¡ã‚‚è‡ªå‹•å±•é–‹ã•ã‚Œã¾ã™ãŒã€ã“ã¡ã‚‰ã®æ©Ÿèƒ½ã¯ã€Œæ¨å¥¨äº‹é …ã€ã‹ã‚‰å¼·åˆ¶é©ç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
ä»¥ä¸‹ã®æ‰‹é †ã§é©ç”¨çŠ¶æ³ã®ç¢ºèªãŠã‚ˆã³å¼·åˆ¶é©ç”¨ã‚’è¡Œã„ã¾ã™ã€‚

### è„†å¼±æ€§è©•ä¾¡ã®å¼·åˆ¶é©ç”¨

1. Azureãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ãã€Defender for Cloud ã‚’é–‹ã

1. [å…¨èˆ¬]-[æ¨å¥¨äº‹é …] ã‚’é–‹ã

    ![](../images/ex01/401-vulnerability.png)

1. ã€Œã‚¿ã‚¤ãƒˆãƒ«ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã€ã—ã€ã€Œãƒã‚·ãƒ³ã«ã¯è„†å¼±æ€§è©•ä¾¡ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦(Machines should have a vulnerability assessment solution)ã€ã‚’æ¢ã—ã¦é¸æŠ

    ![](../images/ex01/402-vulnerability.png)

1. ã€Œå½±éŸ¿ã‚’å—ã‘ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã€ã‹ã‚‰è„†å¼±æ€§è©•ä¾¡ã‚’å±•é–‹ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ã€Œä¿®æ­£ã€

    ![](../images/ex01/403-vulnerability.png)

1. `Microsoft Defender è„†å¼±æ€§ã®ç®¡ç†` ã‚’é¸æŠã—ã¦ã€Œç¶šè¡Œã€ã€ã€ŒNå€‹ã®ãƒªã‚½ãƒ¼ã‚¹ã®ä¿®æ­£ã€ã‚’é¸æŠ

    ![](../images/ex01/404-vulnerability.png)

### è„†å¼±æ€§è©•ä¾¡ã®é©ç”¨ç¢ºèª

1. Defender for Cloud ã®æ¨å¥¨äº‹é …ã§ã€Œãƒã‚·ãƒ³ã«ã¯è„†å¼±æ€§è©•ä¾¡ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€ã‚’å†åº¦é–‹ã

    ![](../images/ex01/405-vulnerability.png)

1. å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã€æ­£å¸¸ãªãƒªã‚½ãƒ¼ã‚¹ã«è¨­å®šã—ãŸãƒªã‚½ãƒ¼ã‚¹ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

    ![](../images/ex01/406-vulnerability.png)



## (å‚è€ƒ) Defender for Servers ã®å€‹åˆ¥é©ç”¨

Defender for Servers ã¯å€‹åˆ¥é©ç”¨ãŒã§ãã‚‹ Defender ã«ãªã‚Šã¾ã™ã€‚
Defender for Servers ã®å€‹åˆ¥é©ç”¨ã¯ã€Œå…¨ä½“é©ç”¨ã—ã¦ä¸€éƒ¨ã‚’é™¤å¤–ã€ã‹ã€Œå…¨ä½“ã¨ã—ã¦ã¯é©ç”¨ã›ãšä¸€éƒ¨ã ã‘ã«é©ç”¨ã€ã®ã©ã¡ã‚‰ã‹ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚
æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ Defender for Servers ã‚’å€‹åˆ¥ã«é©ç”¨ã™ã‚‹æ‰‹é †ã«ã¤ã„ã¦å­¦ç¿’ã—ã¾ã™ã€‚

### Cloud Shellã€€ã®èµ·å‹•

1. [Azure ãƒãƒ¼ã‚¿ãƒ«](https://portal.azure.com/) ã‚’é–‹ã

1. Cloud Shell ã‚’èµ·å‹•

    ![](../images/ex01/901-servers.png)

1. å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã‚’æ“ä½œ

    - `Bash` ã¸åˆ‡ã‚Šæ›¿ãˆ
    - ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ

        ```
        az account set --subscription <YOUR_SUBSCRIPTION_ID>
        ```

### å€‹åˆ¥é©ç”¨æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–

1. ç’°å¢ƒå¤‰æ•°ã‚’æº–å‚™

    ```
    SUBSCRIPTION=<YOUR_SUBSCRIPTION_ID>
    SCOPE_SUBSC=subscriptions/$SUBSCRIPTION
    ```

1. ç¾çŠ¶ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã‚’ç¢ºèª

    ```
    az rest --url https://management.azure.com/$SCOPE_SUBSC/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 
    ```

    `properties.pricingTier` ã‚„ `properties.subPlan` ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ç„¡åŠ¹ã®å ´åˆã¯ `"pricingTier": "Free"` ã€æœ‰åŠ¹ã®å ´åˆã¯ `"pricingTier": "Standard"` ã®è¨­å®šãŒè¿”ã£ã¦ãã¾ã™ã€‚

    - <details>
        <summary>Defender for Servers ãŒç„¡åŠ¹ã®å¿œç­”ä¾‹: </summary>

        ```
        {
            "id": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/providers/Microsoft.Security/pricings/VirtualMachines",
            "name": "VirtualMachines",
            "properties": {
                "freeTrialRemainingTime": "PT0S",
                "pricingTier": "Free",
                "resourcesCoverageStatus": "NotCovered"
            },
            "type": "Microsoft.Security/pricings"
        }
        ```

        </details>

    - <details>
        <summary>Defender for Servers ãŒæœ‰åŠ¹ã®å¿œç­”ä¾‹:</summary>

        ```
        {
            "id": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/providers/Microsoft.Security/pricings/VirtualMachines",
            "name": "VirtualMachines",
            "properties": {
                "enablementTime": "2025-01-04T00:05:39.7654082Z",
                ... (çœç•¥) ...
                "freeTrialRemainingTime": "PT0S",
                "pricingTier": "Standard",
                "resourcesCoverageStatus": "FullyCovered",
                "subPlan": "P2"
            },
            "type": "Microsoft.Security/pricings"
        }
        ```

        </details>

1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€å€‹åˆ¥é©ç”¨ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ï¼ˆ `enforce: False`  ã‚’æŒ‡å®šã§å€‹åˆ¥é©ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ– ï¼‰

    ```
    az rest --method put \
        --url https://management.azure.com/$SCOPE_SUBSC/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 \
        --body "{'properties':{'pricingTier':'Free','enforce':'False'}}" \
        --verbose
    ```

    å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãŠã„ã¦ `properties.enforce: False` ã‚’ç¢ºèª

### å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã« Defender for Servers ã‚’é©ç”¨

1. ç’°å¢ƒå¤‰æ•°ã‚’æº–å‚™

    ```
    SUBSCRIPTION=<YOUR_SUBSCRIPTION_ID>
    RESOURCE_GROUP=<YOUR_RESOURCEGROUP_NAME>
    RESOURCE_PROVIDER=Microsoft.Compute 
    RESOURCE_TYPE=virtualMachines 
    RESOURCE_NAME=<YOUR_VM_NAME>
    SCOPE_RSCNM=subscriptions/$SUBSCRIPTION/resourceGroups/$RESOURCE_GROUP/providers/$RESOURCE_PROVIDER/$RESOURCE_TYPE/$RESOURCE_NAME
    ```

1. ç¾çŠ¶ã®ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã‚’ç¢ºèª

    ```
    az rest --url https://management.azure.com/$SCOPE_RSCNM/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 
    ```

    `properties.pricingTier` ã‚„ `properties.subPlan` ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ç„¡åŠ¹ã®å ´åˆã¯ `"pricingTier": "Free"` ã€æœ‰åŠ¹ã®å ´åˆã¯ `"pricingTier": "Standard"` ã®è¨­å®šãŒè¿”ã£ã¦ãã¾ã™ã€‚

1. å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ Defender for Servers P1 ã‚’é©ç”¨

    ```
    az rest --method put \
        --url https://management.azure.com/$SCOPE_RSCNM/providers/Microsoft.Security/pricings/VirtualMachines?api-version=2024-01-01 \
        --body "{'properties':{'pricingTier':'Standard','subPlan':'P1'}}" \
        --verbose 
    ```

